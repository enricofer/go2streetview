<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html style="width:100%; height:100%">

<head>
    <title>Bing Maps Embedded</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #mapCmds {width:"100%";background-color: #aaaaaa;}
        #cmd {font-size:x-small;padding-right:3px;padding-top:8px;float:left;}

    </style>

    <script type="text/javascript">
        var map;
        var markersLayer;
        var SVpov;
        var markersJson, linesJson;
        var infowindow;
        var storedMarkers = [],
            storedLines = [];
        var lat_param = parseFloat(gup('lat'));
        var long_param = parseFloat(gup('long'));
        var width_param = gup('width');
        var height_param = gup('height');
        var heading_param = parseInt(gup('heading'));
        var z_param = parseInt(gup('zoom'));
        var APIkey_param = gup('APIkey');

var linesJson = "{\"type\": \"FeatureCollection\",\"name\": \"tmp1nlnakut\",\"crs\": { \"type\": \"name\", \"properties\": { \"name\": \"urn:ogc:def:crs:OGC:1.3:CRS84\" } },\"features\": [{ \"type\": \"Feature\", \"properties\": { \"id\": \"7.63\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.82697964937072, 45.393625129602754 ], [ 11.826985337453703, 45.3936239085522 ], [ 11.826986367051953, 45.393624063145936 ], [ 11.827028507642954, 45.393615998505595 ], [ 11.827016164688967, 45.393573458237121 ], [ 11.826897954463245, 45.393598348807927 ], [ 11.826912130763166, 45.393639223618287 ], [ 11.82697964937072, 45.393625129602754 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"4.43\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826947152172476, 45.393701005148465 ], [ 11.826952215488612, 45.393700069713837 ], [ 11.826939455021913, 45.393667080855451 ], [ 11.826943943841215, 45.393649507202767 ], [ 11.826958155376424, 45.393634753175803 ], [ 11.82697964937072, 45.393625129602754 ], [ 11.826912130763166, 45.393639223618287 ], [ 11.826897954463245, 45.393598348807927 ], [ 11.82687796441178, 45.393602264500402 ], [ 11.826832533561735, 45.393610950852448 ], [ 11.826872870369749, 45.393715266642658 ], [ 11.826947152172476, 45.393701005148465 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"9.42\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.827107223316464, 45.393600997152163 ], [ 11.827147973749293, 45.39359323665024 ], [ 11.82722491686598, 45.393578549259828 ], [ 11.827207152012745, 45.393534883040296 ], [ 11.827182304854148, 45.393474739791017 ], [ 11.826991223522551, 45.393511427068795 ], [ 11.827016164688967, 45.393573458237121 ], [ 11.827028507642954, 45.393615998505595 ], [ 11.827107223316464, 45.393600997152163 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"6.58\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.827418110786716, 45.393607248437959 ], [ 11.827402591350065, 45.393570187762727 ], [ 11.827411975584997, 45.393568785087403 ], [ 11.827392508908376, 45.393521740437841 ], [ 11.827378470702211, 45.393524608707317 ], [ 11.827371503045203, 45.393507858711679 ], [ 11.827351904425225, 45.393511944885311 ], [ 11.827312826381151, 45.393519933786322 ], [ 11.82725718573748, 45.393531393348496 ], [ 11.827272248311287, 45.39356954553346 ], [ 11.827297472640282, 45.393568110701423 ], [ 11.82732104543593, 45.393574547737693 ], [ 11.827338182639659, 45.393587715267834 ], [ 11.827341619431717, 45.393592580770502 ], [ 11.827349927180274, 45.393620819293801 ], [ 11.827418110786716, 45.393607248437959 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"8.6\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.827272248311287, 45.39356954553346 ], [ 11.82725718573748, 45.393531393348496 ], [ 11.827254702838209, 45.393525153901557 ], [ 11.827207152012745, 45.393534883040296 ], [ 11.82722491686598, 45.393578549259828 ], [ 11.827272248311287, 45.39356954553346 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"3.73\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.827436487357801, 45.393135756501643 ], [ 11.827383858010661, 45.393125628889244 ], [ 11.827349012448551, 45.39321587434258 ], [ 11.827401509760492, 45.393225915584487 ], [ 11.827436487357801, 45.393135756501643 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"2.25\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.827331380612192, 45.393297772776506 ], [ 11.827288316624879, 45.393292448474554 ], [ 11.827278068130285, 45.393309805009068 ], [ 11.827310540825735, 45.39340243353152 ], [ 11.827331380612192, 45.393297772776506 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"1.07\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.825489386931201, 45.394493926852491 ], [ 11.825488544572423, 45.39448728657036 ], [ 11.825486378852524, 45.394472038049862 ], [ 11.825448183662969, 45.394474694025782 ], [ 11.825451191707705, 45.394496582440411 ], [ 11.825489386931201, 45.394493926852491 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"5.61\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.825576453003087, 45.39449006147877 ], [ 11.825580213113998, 45.394583401636098 ], [ 11.825726148385252, 45.394578978531008 ], [ 11.825722994350828, 45.394484993435569 ], [ 11.825712024876248, 45.394485355042178 ], [ 11.825576453003087, 45.39449006147877 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"2.01\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.825712195838058, 45.394655294699668 ], [ 11.825757812368776, 45.394655425679652 ], [ 11.825757900154871, 45.394631570036601 ], [ 11.825712283662783, 45.394631439445497 ], [ 11.825712195838058, 45.394655294699668 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"4.45\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.82560757876357, 45.39469406976167 ], [ 11.825760902060274, 45.394694324696431 ], [ 11.825761066341174, 45.394677128293395 ], [ 11.825739474937574, 45.394677122533551 ], [ 11.825607743643642, 45.394676873344054 ], [ 11.82560757876357, 45.39469406976167 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"5.55\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.82576068270588, 45.39476165949943 ], [ 11.825760902060274, 45.394694324696431 ], [ 11.82560757876357, 45.39469406976167 ], [ 11.825607149020273, 45.394790484014344 ], [ 11.825648800651031, 45.394790533095133 ], [ 11.825730960652383, 45.394790749560556 ], [ 11.825760604160623, 45.394790825732834 ], [ 11.82576068270588, 45.39476165949943 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"3.44\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.825807151757335, 45.394789133094697 ], [ 11.825806921534841, 45.394787068494608 ], [ 11.825802954639604, 45.39476133336953 ], [ 11.82576068270588, 45.39476165949943 ], [ 11.825760604160623, 45.394790825732834 ], [ 11.825807151757335, 45.394789133094697 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"9.67\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.82599353512329, 45.394668402604836 ], [ 11.826039295089968, 45.394789236850414 ], [ 11.826351544460287, 45.394730468398073 ], [ 11.826305347657593, 45.394608564529939 ], [ 11.82599353512329, 45.394668402604836 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"5.1\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826580370154273, 45.394474566754774 ], [ 11.826628211300998, 45.394598679407416 ], [ 11.826629234368204, 45.39460126465351 ], [ 11.826780479351088, 45.394572675534228 ], [ 11.826732212712663, 45.394445152868236 ], [ 11.826580370154273, 45.394474566754774 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"4.98\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826767711088934, 45.394703420234833 ], [ 11.826751537599412, 45.394663494952091 ], [ 11.826787981830375, 45.394656471552118 ], [ 11.826777704116866, 45.394629722139541 ], [ 11.826636458698319, 45.394656443560933 ], [ 11.826662029667483, 45.394723409832842 ], [ 11.826767711088934, 45.394703420234833 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"5.39\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826787981830375, 45.394656471552118 ], [ 11.826751537599412, 45.394663494952091 ], [ 11.826767711088934, 45.394703420234833 ], [ 11.826785924177063, 45.394750945874009 ], [ 11.826877685744233, 45.394733641343294 ], [ 11.826844174635767, 45.394645808579348 ], [ 11.826787981830375, 45.394656471552118 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"9.43\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826008884691683, 45.394571438863338 ], [ 11.826222503639341, 45.394530594885325 ], [ 11.826184186516587, 45.394430909360395 ], [ 11.825963097669431, 45.394473108428365 ], [ 11.825862867745803, 45.394492242331438 ], [ 11.825901184335519, 45.394591927586625 ], [ 11.826008884691683, 45.394571438863338 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"10.47\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826348434116358, 45.393689728397014 ], [ 11.826348893282832, 45.393691247045666 ], [ 11.826364891044157, 45.393732796806951 ], [ 11.826378128308489, 45.393767664128895 ], [ 11.826495954107855, 45.393745303762628 ], [ 11.826466132101622, 45.393667370836269 ], [ 11.826348434116358, 45.393689728397014 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"5.79\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826562908760826, 45.39394014337838 ], [ 11.826547384956003, 45.393897861923556 ], [ 11.826501808220719, 45.393906191568064 ], [ 11.826405463161059, 45.393923789389135 ], [ 11.826442412578194, 45.394024228699656 ], [ 11.826519638123537, 45.394010074685013 ], [ 11.826522439605387, 45.39401756652574 ], [ 11.826587136093126, 45.394005793021783 ], [ 11.826562908760826, 45.39394014337838 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"3.8\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826547384956003, 45.393897861923556 ], [ 11.826562908760826, 45.39394014337838 ], [ 11.826596836578384, 45.3939339023391 ], [ 11.826581480757051, 45.393892426761603 ], [ 11.826547384956003, 45.393897861923556 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"5.36\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826712176058702, 45.393585127425752 ], [ 11.826571137064102, 45.393613373677873 ], [ 11.826612978246057, 45.393717112024625 ], [ 11.826613706193447, 45.393718894546822 ], [ 11.826684665310564, 45.3937046254592 ], [ 11.826677829413244, 45.39368796220564 ], [ 11.826748032669158, 45.393673891890764 ], [ 11.826712176058702, 45.393585127425752 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"6.13\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826482248637356, 45.394218389947092 ], [ 11.826638874146132, 45.394190118012098 ], [ 11.826602894030824, 45.394091184781971 ], [ 11.826446145058364, 45.394119549772228 ], [ 11.826482248637356, 45.394218389947092 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"6.8\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.826670363144258, 45.394247666406052 ], [ 11.826503676916349, 45.394279157895802 ], [ 11.826554845142674, 45.394413630129833 ], [ 11.826732656676388, 45.39437979236039 ], [ 11.82668061357856, 45.394245702058761 ], [ 11.826670363144258, 45.394247666406052 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"10.98\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.825930283736236, 45.394007294906338 ], [ 11.825994429782867, 45.394174030608163 ], [ 11.82612832731937, 45.394148572084241 ], [ 11.826063119931657, 45.393981052702109 ], [ 11.825930283736236, 45.394007294906338 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"10.38\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.82579626008128, 45.3942095410588 ], [ 11.82587313055995, 45.394195936164991 ], [ 11.825841705357988, 45.394111472073689 ], [ 11.825834240198617, 45.394112917155958 ], [ 11.825801727500568, 45.394032260777649 ], [ 11.825638927983466, 45.394064825001578 ], [ 11.825646332488606, 45.394082644070913 ], [ 11.825706571651017, 45.394227423726463 ], [ 11.82579626008128, 45.3942095410588 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"8.93\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.825706571651017, 45.394227423726463 ], [ 11.825646332488606, 45.394082644070913 ], [ 11.825638927983466, 45.394064825001578 ], [ 11.825636753779087, 45.394059658051503 ], [ 11.825628276404858, 45.394061308271738 ], [ 11.825672608527869, 45.394171466333241 ], [ 11.825657681543817, 45.394174446049625 ], [ 11.82568114839038, 45.394232553495591 ], [ 11.825706571651017, 45.394227423726463 ] ] } },{ \"type\": \"Feature\", \"properties\": { \"id\": \"8.41\", \"html\": \"\", \"icon\": \"\", \"fid\": 0 }, \"geometry\": { \"type\": \"LineString\", \"coordinates\": [ [ 11.825881588478188, 45.394206708596904 ], [ 11.825892212910604, 45.394204554967452 ], [ 11.825853719935878, 45.39410901467074 ], [ 11.825841705357988, 45.394111472073689 ], [ 11.82587313055995, 45.394195936164991 ], [ 11.82579626008128, 45.3942095410588 ], [ 11.825801517342121, 45.394222732784876 ], [ 11.825881588478188, 45.394206708596904 ] ] } }]}"



        window.onload = loadScript;

        function loadScript() {
            console.log('loadScript')
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://maps.googleapis.com/maps/api/js?v=3' +
                '&key=' + APIkey_param + '&callback=GetMap';
            document.body.appendChild(script);
        }

        function clearMarkers() {
            for (var i = 0; i < storedMarkers.length; i++) {
                storedMarkers[i].setMap(null);
            }
            storedMarkers = [];
        }

        function clearLines() {
            for (var i = 0; i < storedLines.length; i++) {
                storedLines[i].setMap(null);
            }
            storedLines = [];
        }

        function readJson() {
            clearMarkers();
            var markers = JSON.parse(markersJson);
            markers.features.forEach(function(feat, i, feats) {
                var coords = feat.geometry.coordinates
                var latLng = new google.maps.LatLng(coords[1], coords[0]);
                var marker = new google.maps.Marker({
                    position: latLng,
                    map: map
                });
                storedMarkers.push(marker)
                if (feat.properties.id != "") {
                    marker.setTitle(feat.properties.id)
                };
                if (feat.properties.icon != "") {
                    marker.setIcon(feat.properties.icon)
                };
                if ((feat.properties.html != "") || (feat.properties.fid != 0)) {
                    if (feat.properties.fid != 0) {
                        footer ='<div id=\"mapCmds\"><div id = \"cmd\"><a href=\"javascript:void(0);\" onclick = \"selectOnMap('+feat.properties.fid+')\">select<\/a><\/div><div id = \"cmd\"><a href=\"javascript:void(0);\" onclick = \"editOnMap('+feat.properties.fid+')\">edit<\/a><\/div><\/div>'
                    } else {
                        footer = ''
                    };
                    marker['info'] = new google.maps.InfoWindow({
                        content: feat.properties.html + footer
                    });
                    google.maps.event.addListener(marker, 'click', function() {
                        this['info'].open(map, this);
                    });
                }
            })
        }

        function readLinesJson() {
            clearLines();
            var lines = JSON.parse(linesJson);
            lines.features.forEach(function(feat, i, feats) {
                var coords = feat.geometry.coordinates;
                var geometry = [];
                console.log(coords)
                console.log("coords")
                coords.forEach(function (point,i) {
                    geometry.push({lat:point[1], lng: point[0]})
                })
                console.log(geometry)
                console.log("geometry")
                var polyline = new google.maps.Polyline({
                    path: geometry,
                    strokeColor: '#FFBB00',//#005CE6
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                    map: map
                });
                polyline.setMap(map);
                storedLines.push(polyline)
            })
        }

        function writeParam() {
              var viewPar = {
                  "transport":"drag",
                  "lat":SVpov.getPosition().lat(),
                  "lon":SVpov.getPosition().lng()
              };
              window.status = JSON.stringify(viewPar);
        }

        function selectOnMap(fid){
            var mapCommand = {
                "transport":"mapCommand",
                "type":"select",
                "fid":fid
            };
            window.status = JSON.stringify(mapCommand);
        }

        function zoomOnMap(fid){
            var mapCommand = {
                "transport":"mapCommand",
                "type":"zoom",
                "fid":fid
            };
            window.status = JSON.stringify(mapCommand);
        }

        function editOnMap(fid){
            var mapCommand = {
                "transport":"mapCommand",
                "type":"edit",
                "fid":fid
            };
            window.status = JSON.stringify(mapCommand);
        }

        function GetMap() {
            console.log('GetMap')
            map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: lat_param,
                    lng: long_param
                },
                zoom: z_param,
                mapTypeId: 'satellite',
                fullscreenControl: false,
                streetViewControl: false,
                mapTypeControl: false

            });
            console.log('0')
            map.setTilt(45);
            console.log('1')
            infowindow = new google.maps.InfoWindow();
            console.log('2')
            SVpov = new google.maps.Marker({
                position: {
                    lat: 45,
                    lng: 11
                },
                draggable: true,
                icon: 'http://icons.iconarchive.com/icons/webalys/kameleon.pics/32/Street-View-icon.png',
                map: map
            });
            //readLinesJson();
        }

        function gup(name) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regexS = "[\\?&]" + name + "=([^&#]*)";
            var regex = new RegExp(regexS);
            var results = regex.exec(window.location.href);
            if (results == null)
                return "";
            else
                return results[1];
        }

    </script>
</head>

<body style="width:100%; height:100%; margin:0 0 0 0;">
    <div id='map'></div>
</body>


</html>
